name: Release Storm POS Desktop App

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Build and release with Tauri Action
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "Storm POS ${{ github.ref_name }}"
          releaseBody: |
            ## Storm POS Desktop App ${{ github.ref_name }}

            Download the Windows installer below — no browser needed.

            **Requirements:** Windows 10/11 · Internet connection required

            **Already installed?** The app will notify you on next launch if an update is available.
          releaseDraft: false
          prerelease: false

      - name: Find sig files and generate latest.json
        shell: pwsh
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag.TrimStart('v')
          $date = (Get-Date -Format 'yyyy-MM-ddTHH:mm:ssZ')

          Write-Host "=== Searching for bundle files ==="
          Get-ChildItem "src-tauri\target\release\bundle" -Recurse | Select-Object FullName | ForEach-Object { Write-Host $_.FullName }

          $nsisDir = "src-tauri\target\release\bundle\nsis"

          $exeFile = Get-ChildItem $nsisDir -Filter "*-setup.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $exeFile) { $exeFile = Get-ChildItem $nsisDir -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1 }

          if (-not $exeFile) {
            Write-Host "No installer found — cannot generate latest.json"
            exit 0
          }

          Write-Host "Installer: $($exeFile.Name)"
          $downloadUrl = "https://github.com/storm-za/Storm-POS/releases/download/$tag/$($exeFile.Name)"

          # Search for .sig file anywhere in bundle directory
          $sigFile = Get-ChildItem "src-tauri\target\release\bundle" -Filter "*.sig" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          $signature = ""
          if ($sigFile) {
            $signature = (Get-Content $sigFile.FullName -Raw).Trim()
            Write-Host "Signature found: $($sigFile.FullName)"
          } else {
            Write-Host "No .sig file found anywhere in bundle"
          }

          $platformEntry = @{ url = $downloadUrl }
          if ($signature -ne "") { $platformEntry.signature = $signature }

          $json = @{
            version  = $version
            notes    = "Improvements and bug fixes."
            pub_date = $date
            platforms = @{ "windows-x86_64" = $platformEntry }
          } | ConvertTo-Json -Depth 5

          $json | Out-File -FilePath "latest.json" -Encoding utf8NoBOM
          Write-Host "=== latest.json ==="
          Get-Content "latest.json"

          gh release upload $tag latest.json --clobber
          Write-Host "Uploaded latest.json"
