name: Release Storm POS Desktop App

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install tauri-cli
        run: cargo binstall tauri-cli --no-confirm

      - name: Bootstrap signing key if missing
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" ]; then
            echo "No signing key found — generating one now..."
            cargo binstall tauri-cli --no-confirm 2>/dev/null || true
            cargo tauri signer generate -w /tmp/tauri.key --ci
            PRIVATE_KEY=$(cat /tmp/tauri.key)
            PUBLIC_KEY=$(cat /tmp/tauri.key.pub)
            echo "Generated public key: $PUBLIC_KEY"
            echo "Store the private key (/tmp/tauri.key content) as TAURI_SIGNING_PRIVATE_KEY in GitHub Secrets"
            echo "PRIVATE_KEY=$PRIVATE_KEY" >> $GITHUB_ENV
          else
            echo "Signing key found in secrets."
          fi

      - name: Build Tauri app
        run: cargo tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""

      - name: Generate latest.json for auto-updater
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag.TrimStart('v')
          $date = (Get-Date -Format 'yyyy-MM-ddTHH:mm:ssZ')

          # Find the NSIS installer and its signature
          $nsisDir = "src-tauri\target\release\bundle\nsis"
          $exeFile = Get-ChildItem $nsisDir -Filter "*.exe" | Where-Object { $_.Name -notlike "*setup.nsis*" } | Select-Object -First 1
          
          if (-not $exeFile) {
            Write-Host "Looking for any exe in nsis dir..."
            $exeFile = Get-ChildItem $nsisDir -Filter "*.exe" | Select-Object -First 1
          }
          
          $sigFile = Get-ChildItem $nsisDir -Filter "*.sig" | Select-Object -First 1

          if ($exeFile -and $sigFile) {
            $exeName = $exeFile.Name
            $signature = Get-Content $sigFile.FullName -Raw
            $signature = $signature.Trim()
            $downloadUrl = "https://github.com/storm-za/Storm-POS/releases/download/$tag/$exeName"
            
            $json = @{
              version = $version
              notes = "Bug fixes and improvements."
              pub_date = $date
              platforms = @{
                "windows-x86_64" = @{
                  signature = $signature
                  url = $downloadUrl
                }
              }
            } | ConvertTo-Json -Depth 5

            $json | Out-File -FilePath "latest.json" -Encoding utf8
            Write-Host "Generated latest.json:"
            Get-Content latest.json
          } else {
            Write-Host "Warning: Could not find installer or signature file. Skipping latest.json."
            Write-Host "Files in nsis dir:"
            Get-ChildItem $nsisDir | Select-Object Name
          }

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Storm POS ${{ github.ref_name }}
          body: |
            ## Storm POS Desktop App ${{ github.ref_name }}

            Download the Windows installer below and install Storm POS as a native desktop app — no browser needed.

            **Requirements:** Windows 10/11 · Internet connection required

            **Already installed?** The app will notify you automatically on next launch.

            **First install:** Download the `.msi` or `-setup.exe` below.
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
            latest.json
          fail_on_unmatched_files: false
